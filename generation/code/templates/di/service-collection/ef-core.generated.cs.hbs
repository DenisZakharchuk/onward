// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: {{generationStamp}}
//     Generated: {{generatedAt}}
//     Source: {{sourceFile}}
// </auto-generated>

using {{baseNamespace}}.Base.Abstractions;
using {{baseNamespace}}.Base.DataAccess;
using {{baseNamespace}}.Base.Services;
{{#if hasOwnership}}
using {{baseNamespace}}.Base.AspNetCore.Extensions;
using {{baseNamespace}}.Base.AspNetCore.Ownership;
using {{baseNamespace}}.Base.Ownership;
{{/if}}
using {{namespace}}.BL.Entities;
using {{namespace}}.BL.Creators;
using {{namespace}}.BL.DataAccess;
using {{namespace}}.BL.DataServices;
using {{namespace}}.BL.DbContexts;
using {{namespace}}.BL.Mappers;
using {{namespace}}.BL.Mappers.Projection;
using {{namespace}}.BL.Modifiers;
using {{namespace}}.BL.SearchProviders;
using {{namespace}}.BL.Services;
using {{namespace}}.BL.Validators;
using {{namespace}}.DTO.ADTs;
{{#each entities}}
using {{../namespace}}.DTO.{{entityName}};
{{/each}}
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;

namespace {{namespace}}.DI;

public static class {{contextName}}ServiceCollectionExtensions
{
    public static IServiceCollection Add{{contextName}}Services(
        this IServiceCollection services,
        Action<DbContextOptionsBuilder> configureDbContext)
    {
        services.AddDbContext<{{contextName}}DbContext>(configureDbContext);
        services.AddScoped<DbContext>(sp => sp.GetRequiredService<{{contextName}}DbContext>());
        services.AddScoped(typeof(IRepository<>), typeof(BaseRepository<>));
        services.AddScoped<I{{contextName}}UnitOfWork, {{contextName}}UnitOfWork>();
        services.AddScoped<IUnitOfWork>(sp => sp.GetRequiredService<I{{contextName}}UnitOfWork>());

        services.AddScoped<ProjectionExpressionBuilder>();

{{#if hasOwnership}}
        // Ownership identity services â€” reads UserId/TenantId from JWT claims
        services.AddOwnershipServices<{{ownershipValueObject}}, {{ownershipFactory}}>();

{{/if}}
        {{#each entities}}
        // {{entityName}}
        services.AddScoped<IMapper<{{entityName}}, {{detailsDtoName}}>, {{mapperName}}>();
        services.AddScoped<IEntityCreator<{{entityName}}, {{createDtoName}}>, {{creatorName}}>();
        services.AddScoped<IEntityModifier<{{entityName}}, {{updateDtoName}}>, {{modifierName}}>();
        services.AddScoped<ISearchQueryProvider<{{entityName}}, {{searchDtoName}}>, {{searchProviderName}}>();
        services.AddScoped<IValidator<{{createDtoName}}>, {{createValidatorName}}>();
        services.AddScoped<IValidator<{{updateDtoName}}>, {{updateValidatorName}}>();
        {{#if isOwned}}
        services.AddScoped<IQueryBuilder<{{entityName}}, {{../ownershipValueObject}}>>(sp =>
            new {{queryBuilderName}}(sp.GetRequiredService<ICurrentIdentityContext<{{../ownershipValueObject}}>>()));
        services.AddScoped<IQueryBuilder<{{entityName}}>>(
            sp => sp.GetRequiredService<IQueryBuilder<{{entityName}}, {{../ownershipValueObject}}>>());
        {{else}}
        services.AddScoped<IQueryBuilder<{{entityName}}>, {{queryBuilderName}}>();
        {{/if}}
        services.AddScoped<IProjectionMapper<{{entityName}}, {{projectionName}}>, {{projectionMapperName}}>();
        services.AddScoped<I{{entityName}}ProjectionMapper, {{projectionMapperName}}>();
        services.AddScoped<{{searchQueryValidatorName}}>();
        {{#if isOwned}}
        services.AddScoped<{{searchServiceName}}>(sp => new {{searchServiceName}}(
            sp.GetRequiredService<IRepository<{{entityName}}>>(),
            sp.GetRequiredService<IQueryBuilder<{{entityName}}, {{../ownershipValueObject}}>>(),
            sp.GetRequiredService<IProjectionMapper<{{entityName}}, {{projectionName}}>>(),
            sp.GetRequiredService<ProjectionExpressionBuilder>(),
            sp.GetRequiredService<{{searchQueryValidatorName}}>(),
            sp.GetRequiredService<ICurrentIdentityContext<{{../ownershipValueObject}}>>(),
            sp.GetRequiredService<Microsoft.Extensions.Logging.ILogger<{{searchServiceName}}>>()
        ));
        services.AddScoped<ISearchService<{{entityName}}, {{projectionName}}, {{../ownershipValueObject}}>>(
            sp => sp.GetRequiredService<{{searchServiceName}}>());
        services.AddScoped<ISearchService<{{entityName}}, {{projectionName}}>>(
            sp => sp.GetRequiredService<{{searchServiceName}}>());
        {{else}}
        services.AddScoped<{{searchServiceName}}>(sp => new {{searchServiceName}}(
            sp.GetRequiredService<IRepository<{{entityName}}>>(),
            sp.GetRequiredService<IQueryBuilder<{{entityName}}>>(),
            sp.GetRequiredService<IProjectionMapper<{{entityName}}, {{projectionName}}>>(),
            sp.GetRequiredService<ProjectionExpressionBuilder>(),
            sp.GetRequiredService<{{searchQueryValidatorName}}>(),
            sp.GetRequiredService<Microsoft.Extensions.Logging.ILogger<{{searchServiceName}}>>()
        ));
        services.AddScoped<ISearchService<{{entityName}}, {{projectionName}}>>(
            sp => sp.GetRequiredService<{{searchServiceName}}>());
        {{/if}}
        services.AddScoped<{{dataServiceInterfaceName}}, {{dataServiceName}}>();

        {{/each}}
        return services;
    }
}
