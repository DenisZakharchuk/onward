// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: {{generationStamp}}
//     Generated: {{generatedAt}}
//     Source: {{sourceFile}}
// </auto-generated>

#nullable enable

using Microsoft.Extensions.DependencyInjection;
using {{namespace}}.BL.Entities;
using {{namespace}}.BL.DataServices;
using {{namespace}}.BL.Creators;
using {{namespace}}.BL.Modifiers;
using {{namespace}}.BL.Mappers;
using {{namespace}}.BL.SearchProviders;
using {{namespace}}.BL.Validators;
using {{namespace}}.DTO.{{entityName}};

namespace {{namespace}}.API.Tests.Services;

public class {{entityName}}DataServiceTests
{
    [Fact]
    public async Task AddAsync_ReturnsSuccess_WhenDtoValid()
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var createdEntity = CreateEntity();
        repository
            .Setup(r => r.CreateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(createdEntity);
        unitOfWork
            .Setup(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(1);

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);
        var dto = CreateValidCreateDto();

        var result = await service.AddAsync(dto);

        result.IsSuccess.Should().BeTrue();
        repository.Verify(r => r.CreateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()), Times.Once);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once);
    }

    {{#if hasInvalidCreateCases}}
    [Theory]
    [MemberData(nameof(InvalidCreateDtos))]
    public async Task AddAsync_ReturnsFailure_WhenDtoInvalid(Create{{entityName}}DTO dto)
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.AddAsync(dto);

        result.IsSuccess.Should().BeFalse();
        repository.Verify(r => r.CreateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()), Times.Never);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never);
    }
    {{/if}}

    [Fact]
    public async Task AddAsync_ReturnsFailure_WhenDtoNull()
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.AddAsync(null!);

        result.IsSuccess.Should().BeFalse();
    }

    [Fact]
    public async Task UpdateAsync_ReturnsSuccess_WhenDtoValid()
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var entity = CreateEntity();
        repository
            .Setup(r => r.GetByIdAsync(It.IsAny<Guid>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(entity);
        repository
            .Setup(r => r.UpdateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(entity);
        unitOfWork
            .Setup(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(1);

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);
        var dto = CreateValidUpdateDto();

        var result = await service.UpdateAsync(dto);

        result.IsSuccess.Should().BeTrue();
        repository.Verify(r => r.UpdateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()), Times.Once);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once);
    }

    {{#if hasInvalidUpdateCases}}
    [Theory]
    [MemberData(nameof(InvalidUpdateDtos))]
    public async Task UpdateAsync_ReturnsFailure_WhenDtoInvalid(Update{{entityName}}DTO dto)
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.UpdateAsync(dto);

        result.IsSuccess.Should().BeFalse();
        repository.Verify(r => r.UpdateAsync(It.IsAny<{{entityName}}>(), It.IsAny<CancellationToken>()), Times.Never);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never);
    }
    {{/if}}

    [Fact]
    public async Task UpdateAsync_ReturnsFailure_WhenDtoNull()
    {
        var repository = new Mock<IRepository<{{entityName}}>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<{{dataServiceName}}>>();
        var serviceProvider = BuildServiceProvider();

        var service = new {{dataServiceName}}(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.UpdateAsync(null!);

        result.IsSuccess.Should().BeFalse();
    }

    {{#if hasInvalidCreateCases}}
    public static IEnumerable<object[]> InvalidCreateDtos => new List<object[]>
    {
        {{#each invalidCreateCases}}
        new object[] { CreateValidCreateDto(dto => dto.{{propertyName}} = {{{invalidValue}}}) },
        {{/each}}
    };
    {{/if}}

    {{#if hasInvalidUpdateCases}}
    public static IEnumerable<object[]> InvalidUpdateDtos => new List<object[]>
    {
        {{#each invalidUpdateCases}}
        new object[] { CreateValidUpdateDto(dto => dto.{{propertyName}} = {{{invalidValue}}}) },
        {{/each}}
    };
    {{/if}}

    private static IServiceProvider BuildServiceProvider()
    {
        var services = new ServiceCollection();
        services.AddLogging();
        services.AddScoped<IValidator<Create{{entityName}}DTO>, Create{{entityName}}Validator>();
        services.AddScoped<IValidator<Update{{entityName}}DTO>, Update{{entityName}}Validator>();
        services.AddScoped<IEntityCreator<{{entityName}}, Create{{entityName}}DTO>, {{entityName}}Creator>();
        services.AddScoped<IEntityModifier<{{entityName}}, Update{{entityName}}DTO>, {{entityName}}Modifier>();
        services.AddScoped<IMapper<{{entityName}}, {{entityName}}DetailsDTO>, {{entityName}}Mapper>();
        services.AddScoped<ISearchQueryProvider<{{entityName}}, {{entityName}}SearchDTO>, {{entityName}}SearchProvider>();
        return services.BuildServiceProvider();
    }

    private static Create{{entityName}}DTO CreateValidCreateDto(Action<Create{{entityName}}DTO>? mutate = null)
    {
        var dto = new Create{{entityName}}DTO
        {
            {{#each createAssignments}}
            {{name}} = {{{value}}},
            {{/each}}
        };

        mutate?.Invoke(dto);
        return dto;
    }

    private static Update{{entityName}}DTO CreateValidUpdateDto(Action<Update{{entityName}}DTO>? mutate = null)
    {
        var dto = new Update{{entityName}}DTO
        {
            Id = Guid.NewGuid(),
            {{#each updateAssignments}}
            {{name}} = {{{value}}},
            {{/each}}
        };

        mutate?.Invoke(dto);
        return dto;
    }

    private static {{entityName}} CreateEntity()
    {
        return new {{entityName}}(
            {{#each constructorArgs}}
            {{{value}}}{{#unless @last}},{{/unless}}
            {{/each}}
        );
    }
}
