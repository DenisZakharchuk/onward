// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: {{generationStamp}}
//     Generated: {{generatedAt}}
//     Source: {{sourceFile}}
//
//     Changes to this file will be lost when regenerated.
//     Override methods in partial class for custom projection logic.
// </auto-generated>

using System.Linq.Expressions;
using {{baseNamespace}}.Base.Abstractions;
using {{baseNamespace}}.Base.ADTs;
using {{namespace}}.Domain.Entities;
using {{namespace}}.DTO.ADTs;

namespace {{namespace}}.Domain.Mappers.Projection;

/// <summary>
/// Projection mapper for {{entityName}} entity.
/// Implements template methods for EF Core expressions and in-memory mapping.
/// </summary>
public class {{entityName}}ProjectionMapper : ProjectionMapperBase<{{entityName}}, {{projectionName}}>, I{{entityName}}ProjectionMapper
{
    {{#if hasRelationships}}
    {{#each relationships}}
    private readonly {{targetMapperInterface}} _{{camelTargetEntity}}Mapper;
    {{/each}}

    public {{entityName}}ProjectionMapper(
        {{#each relationships}}
        {{targetMapperInterface}} {{camelTargetEntity}}Mapper{{#unless @last}},{{/unless}}
        {{/each}}
    )
    {
        {{#each relationships}}
        _{{camelTargetEntity}}Mapper = {{camelTargetEntity}}Mapper;
        {{/each}}
    }
    {{/if}}

    protected override Expression<Func<{{entityName}}, {{projectionName}}>> GetAllFieldsProjection(bool deep, int depth)
    {
        return entity => new {{projectionName}}
        {
            {{#each properties}}
            {{name}} = entity.{{name}},
            {{/each}}
            {{#if hasRelationships}}
            {{#each relationships}}
            {{name}} = deep && depth > 0 && entity.{{name}} != null
                ? new {{targetProjection}}
                {
                    Id = entity.{{name}}.Id,
                    {{!-- Add common properties for nested entities --}}
                }
                : null,
            {{/each}}
            {{/if}}
        };
    }

    protected override Expression<Func<{{entityName}}, {{projectionName}}>> BuildSelectiveProjection(
        ProjectionRequest projection)
    {
        // Evaluate field checks OUTSIDE expression tree for EF Core compatibility
        var requestedFields = new HashSet<string>(
            projection.Fields.Select(f => f.FieldName),
            StringComparer.OrdinalIgnoreCase);

        {{#each properties}}
        var has{{pascalName}} = requestedFields.Contains("{{name}}");
        {{/each}}
        {{#if hasRelationships}}
        {{#each relationships}}
        var has{{name}} = requestedFields.Contains("{{name}}.Id") || requestedFields.Contains("{{name}}.Name");
        {{/each}}
        {{/if}}

        // Use boolean constants in expression tree
        return entity => new {{projectionName}}
        {
            {{#each properties}}
            {{name}} = has{{pascalName}} ? entity.{{name}} : null,
            {{/each}}
            {{#if hasRelationships}}
            {{#each relationships}}
            {{name}} = has{{name}} && entity.{{name}} != null
                ? new {{targetProjection}}
                {
                    Id = entity.{{name}}.Id,
                }
                : null,
            {{/each}}
            {{/if}}
        };
    }

    protected override void MapAllFields(
        {{entityName}} entity,
        {{projectionName}} result,
        bool deep,
        int maxDepth,
        int currentDepth)
    {
        // Map all scalar properties
        {{#each properties}}
        result.{{name}} = entity.{{name}};
        {{/each}}

        {{#if hasRelationships}}
        // Map related entities with depth control
        {{#each relationships}}
        if (deep && current Depth < maxDepth && entity.{{name}} != null)
        {
            var {{camelName}}Projection = ProjectionRequest.AllDeep(maxDepth - currentDepth - 1);
            result.{{name}} = _{{camelTargetEntity}}Mapper.Map(
                entity.{{name}},
                {{camelName}}Projection,
                currentDepth + 1
            );
        }
        {{/each}}
        {{/if}}
    }

    protected override void MapField(
        {{entityName}} entity,
        {{projectionName}} result,
        string fieldName,
        int maxDepth,
        int currentDepth)
    {
        switch (fieldName.ToLower())
        {
            {{#each properties}}
            case "{{camelName}}":
                result.{{name}} = entity.{{name}};
                break;
            {{/each}}
            {{#if hasRelationships}}
            {{#each relationships}}
            case "{{camelName}}.id":
                if (entity.{{name}} != null)
                {
                    result.{{name}} ??= new {{targetProjection}}();
                    result.{{name}}.Id = entity.{{name}}.Id;
                }
                break;
            case "{{camelName}}.name":
                if (entity.{{name}} != null)
                {
                    result.{{name}} ??= new {{targetProjection}}();
                    // Assuming related entity has Name property
                    // Adjust if needed
                }
                break;
            {{/each}}
            {{/if}}
        }
    }
}
