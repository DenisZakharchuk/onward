// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: 20260215-38d150ed
//     Generated: 2026-02-15 09:53:00 UTC
//     Source: simple-bounded-context.json
// </auto-generated>

#nullable enable

using Microsoft.Extensions.DependencyInjection;
using Inventorization.Commerce.Domain.Entities;
using Inventorization.Commerce.Domain.DataServices;
using Inventorization.Commerce.Domain.Creators;
using Inventorization.Commerce.Domain.Modifiers;
using Inventorization.Commerce.Domain.Mappers;
using Inventorization.Commerce.Domain.SearchProviders;
using Inventorization.Commerce.Domain.Validators;
using Inventorization.Commerce.DTO.Address;

namespace Inventorization.Commerce.API.Tests.Services;

public class AddressDataServiceTests
{
    [Fact]
    public async Task AddAsync_ReturnsSuccess_WhenDtoValid()
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var createdEntity = CreateEntity();
        repository
            .Setup(r => r.CreateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(createdEntity);
        unitOfWork
            .Setup(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(1);

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);
        var dto = CreateValidCreateDto();

        var result = await service.AddAsync(dto);

        result.IsSuccess.Should().BeTrue();
        repository.Verify(r => r.CreateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()), Times.Once);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once);
    }

    [Theory]
    [MemberData(nameof(InvalidCreateDtos))]
    public async Task AddAsync_ReturnsFailure_WhenDtoInvalid(CreateAddressDTO dto)
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.AddAsync(dto);

        result.IsSuccess.Should().BeFalse();
        repository.Verify(r => r.CreateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()), Times.Never);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never);
    }

    [Fact]
    public async Task AddAsync_ReturnsFailure_WhenDtoNull()
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.AddAsync(null!);

        result.IsSuccess.Should().BeFalse();
    }

    [Fact]
    public async Task UpdateAsync_ReturnsSuccess_WhenDtoValid()
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var entity = CreateEntity();
        repository
            .Setup(r => r.GetByIdAsync(It.IsAny<Guid>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(entity);
        repository
            .Setup(r => r.UpdateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(entity);
        unitOfWork
            .Setup(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(1);

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);
        var dto = CreateValidUpdateDto();

        var result = await service.UpdateAsync(dto);

        result.IsSuccess.Should().BeTrue();
        repository.Verify(r => r.UpdateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()), Times.Once);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once);
    }

    [Theory]
    [MemberData(nameof(InvalidUpdateDtos))]
    public async Task UpdateAsync_ReturnsFailure_WhenDtoInvalid(UpdateAddressDTO dto)
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.UpdateAsync(dto);

        result.IsSuccess.Should().BeFalse();
        repository.Verify(r => r.UpdateAsync(It.IsAny<Address>(), It.IsAny<CancellationToken>()), Times.Never);
        unitOfWork.Verify(u => u.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never);
    }

    [Fact]
    public async Task UpdateAsync_ReturnsFailure_WhenDtoNull()
    {
        var repository = new Mock<IRepository<Address>>();
        var unitOfWork = new Mock<IUnitOfWork>();
        var logger = new Mock<ILogger<AddressDataService>>();
        var serviceProvider = BuildServiceProvider();

        var service = new AddressDataService(unitOfWork.Object, repository.Object, serviceProvider, logger.Object);

        var result = await service.UpdateAsync(null!);

        result.IsSuccess.Should().BeFalse();
    }

    public static IEnumerable<object[]> InvalidCreateDtos => new List<object[]>
    {
        new object[] { CreateValidCreateDto(dto => dto.Street = string.Empty) },
        new object[] { CreateValidCreateDto(dto => dto.Street = new string('a', 201)) },
        new object[] { CreateValidCreateDto(dto => dto.City = string.Empty) },
        new object[] { CreateValidCreateDto(dto => dto.City = new string('a', 101)) },
        new object[] { CreateValidCreateDto(dto => dto.State = string.Empty) },
        new object[] { CreateValidCreateDto(dto => dto.State = new string('a', 101)) },
        new object[] { CreateValidCreateDto(dto => dto.PostalCode = string.Empty) },
        new object[] { CreateValidCreateDto(dto => dto.PostalCode = new string('a', 21)) },
        new object[] { CreateValidCreateDto(dto => dto.Country = string.Empty) },
        new object[] { CreateValidCreateDto(dto => dto.Country = new string('a', 101)) },
    };

    public static IEnumerable<object[]> InvalidUpdateDtos => new List<object[]>
    {
        new object[] { CreateValidUpdateDto(dto => dto.Id = Guid.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.Street = string.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.Street = new string('a', 201)) },
        new object[] { CreateValidUpdateDto(dto => dto.City = string.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.City = new string('a', 101)) },
        new object[] { CreateValidUpdateDto(dto => dto.State = string.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.State = new string('a', 101)) },
        new object[] { CreateValidUpdateDto(dto => dto.PostalCode = string.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.PostalCode = new string('a', 21)) },
        new object[] { CreateValidUpdateDto(dto => dto.Country = string.Empty) },
        new object[] { CreateValidUpdateDto(dto => dto.Country = new string('a', 101)) },
    };

    private static IServiceProvider BuildServiceProvider()
    {
        var services = new ServiceCollection();
        services.AddLogging();
        services.AddScoped<IValidator<CreateAddressDTO>, CreateAddressValidator>();
        services.AddScoped<IValidator<UpdateAddressDTO>, UpdateAddressValidator>();
        services.AddScoped<IEntityCreator<Address, CreateAddressDTO>, AddressCreator>();
        services.AddScoped<IEntityModifier<Address, UpdateAddressDTO>, AddressModifier>();
        services.AddScoped<IMapper<Address, AddressDetailsDTO>, AddressMapper>();
        services.AddScoped<ISearchQueryProvider<Address, AddressSearchDTO>, AddressSearchProvider>();
        return services.BuildServiceProvider();
    }

    private static CreateAddressDTO CreateValidCreateDto(Action<CreateAddressDTO>? mutate = null)
    {
        var dto = new CreateAddressDTO
        {
            AddressType = AddressType.Shipping,
            Street = new string('a', 1),
            City = new string('a', 1),
            State = new string('a', 1),
            PostalCode = new string('a', 1),
            Country = new string('a', 1),
            IsDefault = true,
        };

        mutate?.Invoke(dto);
        return dto;
    }

    private static UpdateAddressDTO CreateValidUpdateDto(Action<UpdateAddressDTO>? mutate = null)
    {
        var dto = new UpdateAddressDTO
        {
            Id = Guid.NewGuid(),
            AddressType = AddressType.Shipping,
            Street = new string('a', 1),
            City = new string('a', 1),
            State = new string('a', 1),
            PostalCode = new string('a', 1),
            Country = new string('a', 1),
            IsDefault = true,
        };

        mutate?.Invoke(dto);
        return dto;
    }

    private static Address CreateEntity()
    {
        return new Address(
            Guid.NewGuid(),
            AddressType.Shipping,
            new string('a', 1),
            new string('a', 1),
            new string('a', 1),
            new string('a', 1),
            new string('a', 1),
            true
        );
    }
}
