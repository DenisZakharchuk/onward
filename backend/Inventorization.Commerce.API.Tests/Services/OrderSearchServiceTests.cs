// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: 20260215-717476ad
//     Generated: 2026-02-15 18:29:05 UTC
//     Source: simple-bounded-context.json
// </auto-generated>

#nullable enable

using System.Linq.Expressions;
using Microsoft.EntityFrameworkCore;
using Inventorization.Commerce.Domain.Entities;
using Inventorization.Commerce.Domain.Services;
using Inventorization.Commerce.Domain.Validators;
using Inventorization.Commerce.Domain.DbContexts;
using Inventorization.Commerce.DTO.ADTs;

namespace Inventorization.Commerce.API.Tests.Services;

public class OrderSearchServiceTests
{
    [Fact]
    public async Task ExecuteSearchAsync_ReturnsFailure_WhenQueryInvalid()
    {
        var repository = new Mock<IRepository<Order>>();
        var queryBuilder = new Mock<IQueryBuilder<Order>>();
        var projectionMapper = new Mock<IProjectionMapper<Order, OrderProjection>>();
        var expressionBuilder = new ProjectionExpressionBuilder();
        var validator = new OrderSearchQueryValidator();
        var logger = new Mock<ILogger<OrderSearchService>>();

        var service = new OrderSearchService(
            repository.Object,
            queryBuilder.Object,
            projectionMapper.Object,
            expressionBuilder,
            validator,
            logger.Object);

        var invalidQuery = new SearchQuery(pagination: new PageRequest(0, 10));

        var result = await service.ExecuteSearchAsync(invalidQuery);

        result.IsSuccess.Should().BeFalse();
    }

    [Fact]
    public async Task ExecuteSearchAsync_ReturnsSuccess_WhenQueryValid()
    {
        var options = new DbContextOptionsBuilder<CommerceDbContext>()
            .UseInMemoryDatabase(Guid.NewGuid().ToString())
            .Options;
        using var context = new CommerceDbContext(options);

        var entity = CreateEntity();
        context.Set<Order>().Add(entity);
        context.SaveChanges();

        var queryable = context.Set<Order>();
        var repository = new Mock<IRepository<Order>>();
        var queryBuilder = new Mock<IQueryBuilder<Order>>();
        var projectionMapper = new Mock<IProjectionMapper<Order, OrderProjection>>();
        var expressionBuilder = new ProjectionExpressionBuilder();
        var validator = new OrderSearchQueryValidator();
        var logger = new Mock<ILogger<OrderSearchService>>();

        repository.Setup(r => r.GetQueryable()).Returns(queryable);
        queryBuilder.Setup(q => q.BuildQuery(queryable, It.IsAny<SearchQuery>())).Returns(queryable);

        Expression<Func<Order, OrderProjection>> projection = entity => new OrderProjection
        {
            Id = entity.Id
        };
        projectionMapper.Setup(m => m.GetProjectionExpression(It.IsAny<ProjectionRequest?>())).Returns(projection);

        var service = new OrderSearchService(
            repository.Object,
            queryBuilder.Object,
            projectionMapper.Object,
            expressionBuilder,
            validator,
            logger.Object);

        var query = new SearchQuery(pagination: new PageRequest(1, 10));

        var result = await service.ExecuteSearchAsync(query);

        result.IsSuccess.Should().BeTrue();
        result.Data.Should().NotBeNull();
        result.Data!.Items.Should().HaveCount(1);
    }

    private static Order CreateEntity()
    {
        return new Order(
            Guid.NewGuid(),
            "ORD-00000001",
            DateTime.UtcNow,
            0m,
            OrderStatus.Pending,
            Guid.NewGuid()
        );
    }

}
