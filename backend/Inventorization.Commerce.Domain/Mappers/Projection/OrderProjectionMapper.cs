// <auto-generated>
//     This code was generated by the BoundedContext Code Generator.
//     Generation Stamp: 20260214-76e7efc9
//     Generated: 2026-02-14 15:34:46 UTC
//     Source: simple-bounded-context.json
//
//     Changes to this file will be lost when regenerated.
//     Override methods in partial class for custom projection logic.
// </auto-generated>

using System.Linq.Expressions;
using Inventorization.Base.Abstractions;
using Inventorization.Base.ADTs;
using Inventorization.Commerce.Domain.Entities;
using Inventorization.Commerce.DTO.ADTs;

namespace Inventorization.Commerce.Domain.Mappers.Projection;

/// <summary>
/// Projection mapper for Order entity.
/// Implements template methods for EF Core expressions and in-memory mapping.
/// </summary>
public class OrderProjectionMapper : ProjectionMapperBase<Order, OrderProjection>, IOrderProjectionMapper
{
    private readonly ICustomerProjectionMapper _customerMapper;
    private readonly IAddressProjectionMapper _addressMapper;

    public OrderProjectionMapper(
        ICustomerProjectionMapper customerMapper,
        IAddressProjectionMapper addressMapper
    )
    {
        _customerMapper = customerMapper;
        _addressMapper = addressMapper;
    }

    protected override Expression<Func<Order, OrderProjection>> GetAllFieldsProjection(bool deep, int depth)
    {
        return entity => new OrderProjection
        {
            OrderNumber = entity.OrderNumber,
            OrderDate = entity.OrderDate,
            TotalAmount = entity.TotalAmount,
            Status = entity.Status,
            Customer = deep && depth > 0 && entity.Customer != null
                ? new CustomerProjection
                {
                    Id = entity.Customer.Id,
                }
                : null,
            ShippingAddress = deep && depth > 0 && entity.ShippingAddress != null
                ? new AddressProjection
                {
                    Id = entity.ShippingAddress.Id,
                }
                : null,
        };
    }

    protected override Expression<Func<Order, OrderProjection>> BuildSelectiveProjection(
        ProjectionRequest projection)
    {
        // Evaluate field checks OUTSIDE expression tree for EF Core compatibility
        var requestedFields = new HashSet<string>(
            projection.Fields.Select(f => f.FieldName),
            StringComparer.OrdinalIgnoreCase);

        var hasOrderNumber = requestedFields.Contains("OrderNumber");
        var hasOrderDate = requestedFields.Contains("OrderDate");
        var hasTotalAmount = requestedFields.Contains("TotalAmount");
        var hasStatus = requestedFields.Contains("Status");
        var hasCustomer = requestedFields.Contains("Customer.Id") || requestedFields.Contains("Customer.Name");
        var hasShippingAddress = requestedFields.Contains("ShippingAddress.Id") || requestedFields.Contains("ShippingAddress.Name");

        // Use boolean constants in expression tree
        return entity => new OrderProjection
        {
            OrderNumber = hasOrderNumber ? entity.OrderNumber : null,
            OrderDate = hasOrderDate ? entity.OrderDate : null,
            TotalAmount = hasTotalAmount ? entity.TotalAmount : null,
            Status = hasStatus ? entity.Status : null,
            Customer = hasCustomer && entity.Customer != null
                ? new CustomerProjection
                {
                    Id = entity.Customer.Id,
                }
                : null,
            ShippingAddress = hasShippingAddress && entity.ShippingAddress != null
                ? new AddressProjection
                {
                    Id = entity.ShippingAddress.Id,
                }
                : null,
        };
    }

    protected override void MapAllFields(
        Order entity,
        OrderProjection result,
        bool deep,
        int maxDepth,
        int currentDepth)
    {
        // Map all scalar properties
        result.OrderNumber = entity.OrderNumber;
        result.OrderDate = entity.OrderDate;
        result.TotalAmount = entity.TotalAmount;
        result.Status = entity.Status;

        // Map related entities with depth control
        if (deep && currentDepth < maxDepth && entity.Customer != null)
        {
            var customerProjection = ProjectionRequest.AllDeep(maxDepth - currentDepth - 1);
            result.Customer = _customerMapper.Map(
                entity.Customer,
                customerProjection,
                currentDepth + 1
            );
        }
        if (deep && currentDepth < maxDepth && entity.ShippingAddress != null)
        {
            var shippingAddressProjection = ProjectionRequest.AllDeep(maxDepth - currentDepth - 1);
            result.ShippingAddress = _addressMapper.Map(
                entity.ShippingAddress,
                shippingAddressProjection,
                currentDepth + 1
            );
        }
    }

    protected override void MapField(
        Order entity,
        OrderProjection result,
        FieldProjection field,
        int currentDepth)
    {
        var fieldName = field.FieldName.ToLower();
        
        switch (fieldName)
        {
            case "orderNumber":
                result.OrderNumber = entity.OrderNumber;
                break;
            case "orderDate":
                result.OrderDate = entity.OrderDate;
                break;
            case "totalAmount":
                result.TotalAmount = entity.TotalAmount;
                break;
            case "status":
                result.Status = entity.Status;
                break;
            case "customer.id":
                if (entity.Customer != null)
                {
                    result.Customer ??= new CustomerProjection();
                    result.Customer.Id = entity.Customer.Id;
                }
                break;
            case "customer.name":
                if (entity.Customer != null)
                {
                    result.Customer ??= new CustomerProjection();
                    // Assuming related entity has Name property
                    // Adjust if needed
                }
                break;
            case "shippingAddress.id":
                if (entity.ShippingAddress != null)
                {
                    result.ShippingAddress ??= new AddressProjection();
                    result.ShippingAddress.Id = entity.ShippingAddress.Id;
                }
                break;
            case "shippingAddress.name":
                if (entity.ShippingAddress != null)
                {
                    result.ShippingAddress ??= new AddressProjection();
                    // Assuming related entity has Name property
                    // Adjust if needed
                }
                break;
        }
    }
}
